name: Generate AI Translations

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  generate-translations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Generate translations (forces generation)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}          # 선택
          NOTION_TRANSLATION_DATABASE_ID: ${{ secrets.NOTION_TRANSLATION_DATABASE_ID }}  # 선택
          AI_TRANSLATIONS_BACKGROUND: "0"  # 강제 생성
          AI_TRANSLATIONS_DISABLED: ""     # 생성 차단 해제
        run: npm run generate:translations

      # 선택 1: 번역 JSON을 저장소에 커밋 (repo가 허용될 때)
      # - name: Commit translated JSON
      #   run: |
      #     git config user.name "github-actions[bot]"
      #     git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git add public/ai-translations data/ai-translations || true
      #     git commit -m "chore: update ai translations" || echo "No changes"
      #     git push

      # 선택 2: S3/Blob 업로드 후 빌드 전에 다운로드 (별도 스텝 추가)

      # 선택 3: Notion만 외부 저장소로 사용 (pushToNotion은 syncAiTranslations 내부에서 수행)

      - name: Trigger Vercel deploy (optional)
        if: ${{ env.VERCEL_DEPLOY_HOOK_URL != '' }}
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: curl -X POST "$VERCEL_DEPLOY_HOOK_URL"
